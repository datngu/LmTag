#!/usr/bin/env Rscript

# Author: Dat T Nguyen <n.dat@outlook.com>
# Date: 15 March 2021
# revised: 15 June 2021

# 06 April 2022
# add model interaction

# This script is use to build model for imputation R2.

###############
options(stringsAsFactors = FALSE)

args = commandArgs(trailingOnly=TRUE)
syntax='\nUsage:\t./buid_imputation_model.R imputation_Rdata=path/to/imputation_result.Rdata find_snp=path/to/find_snp_output.txt out_Rdata=path/to/Out_model_name.Rdata.\n
Input parameters are:
\timputation_Rdata=path/to/imputation_result.Rdata : path to computed imputation accuracy Rdata file (generated by compute_imputation_accuracy.R)
\tfind_snp=path/to/find_snp_output.txt (generated by: "LmTag find" command)
\tout_Rdata=path/to/your/Out_model_name.Rdata (model output exported as Rdata file)\n'


imputation_path = find_snp_path = out_Rdata_path = NA

if(length(args) == 0 ){
  cat("\nNo argument, Program stop! \n")
  cat(syntax)
  quit()
}

for (i in 1:length(args)){
  res=unlist(strsplit(args[i],"="))
  if (res[1] == "imputation_Rdata") imputation_path = res[2]
  if (res[1] == "find_snp") find_snp_path = res[2]
  if (res[1] == "out_Rdata") out_Rdata_path = res[2]
}

# setwd("/media/datn/data/DatProjects/vn_array/dev_LmTag_fun/test_LmTag_v1_chr10")
# imputation_path="naive_chr10.Rdata"
# find_snp_path="chr10_find_snp_output.txt"
# out_Rdata_path="chr10_model.Rdata"

if(is.na(imputation_path)){
  cat(syntax)
  cat("imputation_path is not found! Program stop!\n\n")
  quit()
}

if(is.na(find_snp_path)){
  cat(syntax)
  cat("find_snp_path is not found! Program stop!\n\n")
  quit()
}

if(is.na(out_Rdata_path)){
  out_Rdata_path="imputation_model.Rdata"
  cat("out_Rdata is not found! default value is used: \"imputation_model.Rdata\" \n\n")
}




load(imputation_path)
data$AF = data$INFO
find_snp = read.table(find_snp_path, header = TRUE)
train = data.frame(tag = find_snp[,2], tagged = find_snp[,1], r2 = find_snp[,3], row.names = NULL)
train = train[train$tag != 0,]
train = train[train$tag != train$tagged,]
pick = train$tagged %in% train$tag
train = train[!pick,]

train$tag_AF = data$AF[match(train$tag, data$POS)]
train$tagged_AF = data$AF[match(train$tagged, data$POS)]
train$distance = abs(train$tag - train$tagged)
train$R2 = train$r2
train$imputed_R2 = data$r_2[match(train$tagged, data$POS)]

# model linear

model <- lm(imputed_R2 ~ R2 + tag_AF + tagged_AF + distance, data = train)
cat("\nMODEL LINEAR SUMMARY: \n\n")
summary(model)
sink(paste0(out_Rdata_path, "_model_linear_summary.txt"))
print(summary(model))
sink() 

# model interaction
model_interaction <- lm(imputed_R2 ~ R2*tagged_AF + R2 + tag_AF + tagged_AF + distance, data = train)
cat("\nMODEL INTERACTION SUMMARY: \n\n")
summary(model_interaction)
sink(paste0(out_Rdata_path, "_model_interaction_summary.txt"))
print(summary(model_interaction))
sink() 

save(model, model_interaction, data, train, file = out_Rdata_path)
cat(paste0("output saved: ", out_Rdata_path))
cat("\n\nDone!\n\n")



