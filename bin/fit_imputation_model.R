#!/usr/bin/env Rscript

# Author: Dat T Nguyen <n.dat@outlook.com>
# Date: 15 March 2021
# revised: 15 June 2021

# This script is use to fit model for imputation R2.

###############
options(stringsAsFactors = FALSE)

args = commandArgs(trailingOnly=TRUE)
syntax='\nUsage:\t./imputation_model.R model_Rdata=path/to/model.Rdata df=path/to/af.txt ld=path/to/your/file.ld ld_cutoff=0.8 out_ld=path/to/fitted_ld.txt\n
Input parameters are:
\tmodel_Rdata=path/to/model.Rdata : path to computed model (generated by ./buid_imputation_model.R)
\taf=path/to/af.txt (generated by: bcftoools in previous step.)
\tld=path/to/your/file.ld (generated by Plink 1.9)
\tout_ld=path/to/your/fitted_ld.txt (output is ld file with predicted imputation scores)
\tld_cutoff=0.8 (pairwise R2 cutoff default is 0.8)\n'

model_path = ld_path = af_path = ld_cutoff = out_put_ld_path = NA

if(length(args) == 0 ){
  cat("\nNo argument, Program stop! \n")
  cat(syntax)
  quit()
}

for (i in 1:length(args)){
  res=unlist(strsplit(args[i],"="))
  if (res[1] == "model_Rdata") model_path = res[2]
  if (res[1] == "af") af_path = res[2]
  if (res[1] == "ld") ld_path = res[2]
  if (res[1] == "ld_cutoff") ld_cutoff = as.numeric(res[2])
  if (res[1] == "out_ld") out_put_ld_path = res[2]
}

# setwd("/media/datn/data/DatProjects/vn_array/test_full_pipeline")
# imputation_path="test_chr18.Rdata"
# find_snp_path="chr18_find_snp_output.txt"
# ld_path="18_ld_0.2.ld"
# ld_cutoff=0.8


if(is.na(model_path)){
  cat(syntax)
  cat("model_path is not found! Program stop!\n\n")
  quit()
}

if(is.na(ld_path)){
  cat(syntax)
  cat("ld_path is not found! Program stop!\n\n")
  quit()
}

if(is.na(af_path)){
  cat(syntax)
  cat("af_path is not found! Program stop!\n\n")
  quit()
}

if(is.na(out_put_ld_path)){
  out_Rdata_path="ld_fitted_model.txt"
  cat("ld_path is not found! default value is used: \"ld_fitted_model.txt\" \n\n")
}

if ( is.na(ld_cutoff)){
  ld_cutoff = 0.8
  cat("ld_cutoff is not found! default value is used: 0.8 \n\n")
}

load(model_path)
af = read.table(af_path, header = TRUE)

ld = read.table(ld_path, header = T)
pick_col_all = names(ld)
ld$distance = abs(ld$BP_A - ld$BP_B)
ld$R2 = ld$R ^ 2

pick_col = c("BP_A", "BP_B", "R2", "distance")
test_a = test_b = ld[,pick_col]

test_a$tag_AF = af$AF[match(test_a$BP_A, af$POS)]
test_a$tagged_AF = af$AF[match(test_a$BP_B, af$POS)]

test_b$tag_AF = af$AF[match(test_b$BP_B, af$POS)]
test_b$tagged_AF = af$AF[match(test_b$BP_A, af$POS)]

a = predict(model, test_a)
b = predict(model, test_b)

ld = ld[, pick_col_all]
ld$BP_A_score = a
ld$BP_B_score = b

ld = ld[ld$R^2 >= ld_cutoff,]

write.table(ld, file = out_put_ld_path, quote = F, sep = "\t", row.names = F)

cat(paste0("\nOutput: ", out_put_ld_path, ".\n"))
cat("Done!\n\n")

